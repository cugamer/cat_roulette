<h1>Cat Roulette 1.0</h1>

<div class="my-flipster">
  <ul class="flip-items" id="cat-carousel">
  	<% @metadata.each do |cat| %>

    	<li>
    		<div class="cat-div">
	    		<img src="<%= get_post_image_url(cat) %>" class="cat-pic" />
	    		<p>Provided by <a href="<%= get_post_url(cat) %>" target="_blank"><%= get_post_blog_name(cat) %></a></p>
	    	</div>
    	</li>

  	<% end %>

  </ul>

  <button type="button" id="wheel-spin">Spin the Wheel</button>
</div>


<script>
	var flipContainer = $('.my-flipster'),
	    flipItemContainer = flipContainer.find('.flip-items'),
	    flipItem = flipContainer.find('li');

	flipContainer.flipster({
	  itemContainer: flipItemContainer,
	  itemSelector: flipItem,
	  loop: 2,
	  start: 2,
	  style: 'infinite-carousel'
	});

	function spinTheWheel(minSpins){
		steps = Math.floor(Math.random() * 20) + minSpins;
		for (var i = 1; i <= steps; i++) {
		    setTimeout(function() { flipContainer.flipster('next'); }, 
		    	100 * i );
		}
	};

	spinTheWheel(8);

	$("#wheel-spin").click(function(){
		spinTheWheel(8);
		replacementData = getReplacementImageData("<%= cats_newimage_path %>");
		randomNum = getRandomListPos();

		replaceImage(randomNum, replacementData.image_url);
		replaceBlogInfo(randomNum, replacementData.post_url, replacementData.blog_name)
	});


	function getReplacementImageData(url){
		var output;
		var scriptURL = url;

		$.ajax({
			url: scriptURL,
			type: 'get',
			dataType: 'json',
			async: false,
			success: function(data){
				output = data;
			}
		});

		return output;
	};

	function replaceImage(targetPos, imageUrl){
		$("ul li:nth-child(" + targetPos + ") div div img").replaceWith('<img src=' + imageUrl + ' class="cat-pic">')
	}

	function replaceBlogInfo(targetPos, blogURL, blogName){
		$("ul li:nth-child(" + targetPos + ") div div p a").replaceWith('<a href=' + blogURL + ' target="_blank">' + blogName + '</a>')
	}

	function getRandomListPos(){
		var numFlipseterItems = $('.flipster__item').length;
		var numToReplace = Math.floor(Math.random() * numFlipseterItems) + 1;
		return numToReplace;
	}
	
</script>


